<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8" />
    <title>Crabul!</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="index.css">

</head>

<body>
    <div id="notification-container"></div>

    <div id="drawn-card-modal" class="custom-modal">
        <div class="custom-modal-content">
            <img id="drawn-card" src="cards/0_1.svg" alt="Card" class="img-fluid mb-3">
            <div class="d-flex justify-content-around">
                <button id="discard-card-btn" class="btn btn-danger">Discard</button>
                <button id="swap-card-btn" class="btn btn-success">Swap</button>
            </div>
        </div>
    </div>

    <div id="peeked-card-modal" class="custom-modal">
        <div class="custom-modal-content">
            <img id="peeked-card" src="cards/0_1.svg" alt="Card" class="img-fluid mb-3">
            <div class="d-flex justify-content-around">
                <button id="close-peeked-card-btn" class="btn btn-danger">Close</button>
            </div>
        </div>
    </div>

    <div id="game-result-modal" class="custom-modal" style="display: none;">
        <div class="custom-modal-content larger">
            <div id="game-scores"></div>
        </div>
    </div>

    <div id="lobby">
        <div class="d-flex flex-column align-items-center vh-100 bg-dark text-white">
            <div class="mb-4">
                <picture>
                    <source srcset="crabul_logo.png" media="(prefers-color-scheme: dark)" />
                    <img id="logo-img" src="crabul_logo.png" alt="Crabul Logo" class="img-fluid"
                        style="width: 400px; height: 400px;" />
                </picture>
            </div>

            <div class="bg-secondary p-5 rounded shadow-lg text-center" style="width: 100%; max-width: 400px;">
                <form class="mb-3">
                    <div class="mb-3">
                        <input type="text" id="name" class="form-control" placeholder="Enter your name" />
                    </div>

                    <div class="d-grid mb-3">
                        <button disabled id="new-room-button" type="button" class="btn btn-primary btn-lg">
                            Create New Room
                        </button>
                    </div>
                    or
                    <div class="input-group mt-3">
                        <input id="room-code-input" type="text" class="form-control" placeholder="Enter room code" />
                        <button disabled id="join-room-button" type="button" class="btn btn-primary">
                            Join Room
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="waiting-room" style="display: none;">
        <div class="d-flex flex-column align-items-center vh-100 bg-dark text-white">
            <div class="mb-4">
                <picture>
                    <source srcset="crabul_logo.png" media="(prefers-color-scheme: dark)" />
                    <img src="crabul_logo.png" alt="Crabul Logo" class="img-fluid"
                        style="width: 150px; height: 150px;" />
                </picture>
            </div>

            <div class="bg-secondary p-4 rounded shadow-lg text-center mb-4" style="width: 100%; max-width: 400px;">
                <h5 class="mb-1" style="font-size: 1rem;">"Room Code"</h5>

                <div id="room-code-plh" class="p-2" style="font-size: 2rem; font-weight: bold;">
                    <!-- {room_id} -->
                </div>
            </div>

            <div class="bg-secondary p-4 rounded shadow-lg text-center" style="width: 100%; max-width: 400px;">
                <h4 class="mb-3">"Players"</h4>

                <div id="players-container" class="d-flex flex-column">
                </div>

                <div class="d-grid mt-3">
                    <button id="start-game-button" type="button" class="btn btn-primary btn-lg">
                        Waiting for more players...
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-room" style="display: none;">
        <div class="d-flex flex-column align-items-center vh-100 bg-dark text-black">
            <div class="">
                <picture>
                    <source srcset="crabul_logo.png" media="(prefers-color-scheme: dark)" />
                    <img src="crabul_logo.png" alt="Crabul Logo" class="img-fluid"
                        style="width: 150px; height: 150px;" />
                </picture>
            </div>
            <div class="container-lg d-flex">
                <!-- Left side with stacked player items -->
                <div id="player-card-container" class="col-6 d-flex flex-column gap-2 p-3">
                </div>
                <div class="col-6 d-flex flex-column justify-content-center align-items-center">
                    <div class="d-flex gap-4 align-items-center">
                        <!-- Deck image -->
                        <img id="discard-pile" src="cards/empty.svg" alt="Discard Pile" class="discard-img"
                            style="width: 120px;">

                        <img src="cards/deck.svg" alt="Deck" class="img-fluid ms-3" style="width: 150px;">

                        <!-- Discard pile image -->
                    </div>
                </div>
            </div>
            <div class="container mt-4">
                <div class="row">
                    <!-- Buttons Section (Inline) -->
                    <div class="col-12 d-flex justify-content-center gap-3 mb-4">
                        <button disabled id="draw-card-btn" class="btn btn-primary">Draw Card</button>
                        <button disabled id="crabul-btn" class="btn btn-primary">Go Crabul</button>
                    </div>

                    <!-- Main Player Card Section -->
                    <div class="col">
                        <div class="p-3 rounded">
                            <div class="fw-bold text-center text-white">
                                <span id="power-container">

                                </span>
                                <button id="end-turn-button" class="btn btn-primary"
                                    style="display: none; margin-left: 20px;">End Turn</button>
                            </div>


                            <div class="fw-bold text-center">Your cards</div>
                            <div id="main-player-card-container" class="d-flex justify-content-center gap-4 p-3 mt-2">
                                <!-- Player cards will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const waitingRoom = document.getElementById("waiting-room");
        const lobby = document.getElementById("lobby");
        const gameRoom = document.getElementById("game-room");
        const nameInput = document.getElementById('name');
        const romeCodeInput = document.getElementById('room-code-input');
        const newRoomButton = document.getElementById('new-room-button');
        const joinRoomButton = document.getElementById('join-room-button');
        const playersContainer = document.getElementById("players-container");
        const startGameButton = document.getElementById("start-game-button");
        const playerCardContainer = document.getElementById("player-card-container");
        const mainPlayerCardContainer = document.getElementById("main-player-card-container");

        const drawButton = document.getElementById("draw-card-btn");
        const crabulButton = document.getElementById("crabul-btn");

        const drawnCardModal = document.getElementById("drawn-card-modal");
        const drawnCard = document.getElementById("drawn-card");
        const discardButton = document.getElementById("discard-card-btn");
        const swapButton = document.getElementById("swap-card-btn");

        const peekedCardModal = document.getElementById("peeked-card-modal");
        const peekedCard = document.getElementById("peeked-card");
        const closePeekedCardButton = document.getElementById("close-peeked-card-btn");

        const discardPile = document.getElementById("discard-pile");

        const powerContainer = document.getElementById("power-container");

        const endTurnButton = document.getElementById("end-turn-button");


        var playersLoaded = false;
        var userPlayerId;
        var userPlayerName;
        var players = {};
        var powerState = null;
        var oldPowerState = null;
        var oldPowerContainerText = null;


        nameInput.addEventListener('input', () => {
            if (nameInput.value.trim() === '') {
                newRoomButton.disabled = true;  // Disable button if input is empty
                joinRoomButton.disabled = true;  // Disable button if input is empty
            } else {
                newRoomButton.disabled = false;  // Disable button if input is empty
                joinRoomButton.disabled = false;  // Disable button if input is empty
            }
        });

        newRoomButton.addEventListener('click', () => {
            connect_ws("connect")
        })

        joinRoomButton.addEventListener('click', () => {
            connect_ws(`connect/${romeCodeInput.value}`)
        })

        startGameButton.addEventListener('click', () => {
            socket.send("/start");
        })

        drawButton.addEventListener('click', () => {
            socket.send("/draw");
        })

        crabulButton.addEventListener('click', () => {
            socket.send("/crabul");
        })

        discardButton.addEventListener('click', () => {
            socket.send("/discard");
            drawnCardModal.style.display = 'none';
        })
        swapButton.addEventListener('click', () => {
            drawnCardModal.style.display = 'none';
            powerState = "Swap";
            powerContainer.innerText = "SWAP WITH ONE OF YOUR CARD!";
        })


        closePeekedCardButton.addEventListener('click', () => {
            peekedCardModal.style.display = 'none';
        })

        endTurnButton.addEventListener('click', () => {
            socket.send("/pow4_2 ");
        })

        function connect_ws(endpoint) {
            const { location } = window
            const proto = location.protocol.startsWith('https') ? 'wss' : 'ws'
            const wsUri = `${proto}://${location.host}/${endpoint}?name=${nameInput.value}`

            socket = new WebSocket(wsUri)

            socket.onopen = () => {
                lobby.remove();
                waitingRoom.style.display = "block";
            }

            socket.onmessage = ev => {
                console.log(ev.data)
                const msg = JSON.parse(ev.data);
                console.log(msg)
                handleMessage(msg)
            }

            socket.onclose = () => {
                socket = null
            }
        }

        function handleMessage(data) {
            if (data === "OperationNotAllowedAtCurrentState") {
                createNotification(`Operation not allowed in the current state`, true);
                return;
            }
            if ("PlayerJoined" in data) {
                const roomCode = data["PlayerJoined"]["room_id"];
                const playerId = data["PlayerJoined"]["player_id"];
                const playerName = data["PlayerJoined"]["player_name"];
                const playerList = data["PlayerJoined"]["player_list"];
                const roomCodeElement = document.getElementById("room-code-plh");
                roomCodeElement.innerHTML = roomCode;

                if (playersLoaded) {
                    addPlayer(playerId, playerName);
                } else {
                    for (let playerID in playerList) {
                        // Access the key and the value                   
                        addPlayer(playerID, playerList[playerID]);
                    }
                    delete players[playerId];
                    userPlayerId = playerId;
                    userPlayerName = playerName;
                    playersLoaded = true;
                    updateStartButtonText();
                }
                return;
            }
            if ("PlayerLeft" in data) {
                const playerId = data["PlayerLeft"];
                removePlayer(playerId);
                return;
            }
            if ("PeekingPhaseStarted" in data) {
                startGame(data["PeekingPhaseStarted"]);
                return;
            }
            if ("PlayerTurn" in data) {
                endTurnButton.style.display = "none"; //check a better place to put ths
                if (data["PlayerTurn"] === userPlayerId) {
                    createNotification(`Your turn`);
                    drawButton.disabled = false;
                    crabulButton.disabled = false;
                } else {
                    createNotification(`Player turn: ${players[data["PlayerTurn"]]}`);
                    drawButton.disabled = true;
                    crabulButton.disabled = true;
                }
                coverCards();
                highlightCurrentPlayer(data["PlayerTurn"]);
                return;
            }
            if ("CardWasDrawn" in data) {
                if (data["CardWasDrawn"] != userPlayerId) {
                    createNotification(`Player ${players[data["CardWasDrawn"]]} drew a card from the deck`);
                } else {
                    drawButton.disabled = true;
                    crabulButton.disabled = true;
                }
                return;
            }
            if ("PlayerWentCrabul" in data) {
                if (data["PlayerWentCrabul"] != userPlayerId) {
                    createNotification(`Player ${players[data["PlayerWentCrabul"]]} went CRABUL!`);
                    const badge = document.getElementById(`crabul-badge-${data["PlayerWentCrabul"]}`);
                    badge.classList.remove('d-none');
                } else {
                    drawButton.disabled = true;
                    crabulButton.disabled = true;
                }
                return;
            }
            if ("DrawnCard" in data) {
                drawnCard.src = getCardImage(data["DrawnCard"]);
                drawnCardModal.style.display = 'flex';
                return;
            }
            if ("CardSwapped" in data) {
                if (data["CardSwapped"][0] != userPlayerId) {
                    createNotification(`Player ${players[data["CardSwapped"][0]]} swapped card ${data["CardSwapped"][1] + 1}`);
                }
                return;
            }
            if ("CardDiscarded" in data) {
                if (data["CardDiscarded"][0] != userPlayerId) {
                    createNotification(`Player ${players[data["CardDiscarded"][0]]} discarded a card`);
                }
                discardPile.src = getCardImage(data["CardDiscarded"][1]);
                return;
            }
            if ("PowerActivated" in data) {
                if (data["PowerActivated"][0] != userPlayerId) {
                    createNotification(`Player ${players[data["PowerActivated"][0]]} activated a power: ${data["PowerActivated"][1]}`);
                } else {
                    powerState = data["PowerActivated"][1];
                    powerContainer.innerText = "POWER " + data["PowerActivated"][1] + " ACTIVE!";
                }
                return;
            }
            if ("PowerUsed" in data) {
                if (data["PowerUsed"][1] != userPlayerId) {
                    sendPowerUsedNotification(data["PowerUsed"]);
                } else {
                    if (data["PowerUsed"][0] === "CheckAndSwapStage1") {
                        powerState = "CheckAndSwapStage2";
                        powerContainer.innerText = "SWAP WITH ONE OF YOUR CARD OR END TURN";
                        endTurnButton.style.display = 'block';
                    } else {
                        powerState = null;
                        powerContainer.innerText = "";
                    }
                }
                return;
            }
            if ("PeekedCard" in data) {
                peekedCard.src = getCardImage(data["PeekedCard"]);
                peekedCardModal.style.display = 'flex';
            }
            if ("GameTerminated" in data) {
                showGameResults(data);
            }

            if ("SameCardAttempt" in data) {
                if (data["SameCardAttempt"][4] !== "Success") {
                    addCard(data["SameCardAttempt"][0]);
                    if (data["SameCardAttempt"][0] in players) {
                        createNotification(`${players[data["SameCardAttempt"][0]]} attempted to throw a diplicate unsuccessfully: ${data["SameCardAttempt"][4]}, receiving a penalty card`);
                    } else {
                        createNotification(`You attempted to throw a duplicate unsuccessfully: ${data["SameCardAttempt"][4]}, receive a penalty card`);
                    }
                } else {
                    if (data["SameCardAttempt"][0] in players) {
                        createNotification(`Player ${players[data["SameCardAttempt"][0]]} threw a duplicate successfully`);
                    } else {
                        createNotification(`You threw a duplicate successfully`);
                    }

                    removeCard(data["SameCardAttempt"][1]);
                    if (data["SameCardAttempt"][0] != data["SameCardAttempt"][1]) {
                        oldPowerState = powerState;
                        oldPowerContainerText = powerContainer.innerText;

                        if (data["SameCardAttempt"][0] in players) {
                            powerState = "WaitingForChoosingCardToGive";
                            powerContainer.innerText = `PAUSE! Game will resume after ${data["SameCardAttempt"][0]} choose the card to substitute`;
                        } else {
                            powerState = "ChoosingCardToGive";
                            powerContainer.innerText = "PICK ONE OF YOUR CARD TO SUBSTITUTE!";
                        }
                    }
                    discardPile.src = getCardImage(data["SameCardAttempt"][3]);
                }
            }
            if ("CardReplaced" in data) {
                if (data["CardReplaced"][0] in players) {
                    createNotification(`${players[data["CardReplaced"][0]]} have replaced the duplicate with card ${data["CardReplaced"][1]}`);
                }
                removeCard(data["CardReplaced"][0]);
                addCard(data["CardReplaced"][2]);
                powerState = oldPowerState;
                powerContainer.innerText = oldPowerContainerText;
            }
        }



        function addCard(userId) {
            if (userId in players) {
                let cards = document.querySelectorAll(`[id^="player-${userId}-card-"]`);
                const playerCard = `
                    <img id="player-${userId}-card-${cards.length}" src="cards/retro.svg" alt="Card" class="img-fluid hover-zoom" style="width: 60px;" draggable="true">
                `;
                document.getElementById(`cards-container-player-${userId}`).insertAdjacentHTML("beforeend", playerCard);
                initializeDroppableCard(document.getElementById(`player-${userId}-card-${cards.length}`));
            } else {
                let cards = document.querySelectorAll(`[id^="main-card-"]`);

                const playerCard = `
                    <img id="main-card-${cards.length}" src="cards/retro.svg" alt="Card" class="img-fluid hover-zoom" style="width: 70px;" draggable="true">    
                `;
                mainPlayerCardContainer.insertAdjacentHTML("beforeend", playerCard);
                initializeDraggableCard(document.getElementById(`main-card-${cards.length}`));
            }
        }

        function removeCard(userId) {
            if (userId in players) {
                let cards = document.querySelectorAll(`[id^="player-${userId}-card-"]`);
                document.getElementById(`player-${userId}-card-${cards.length - 1}`).remove();
            } else {
                let cards = document.querySelectorAll(`[id^="main-card-"]`);
                document.getElementById(`main-card-${cards.length - 1}`).remove();
            }
        }

        function sendPowerUsedNotification(power) {
            if (power[0] === "PeekOwnCard") {
                if (power[1] in players) {
                    createNotification(`Player ${players[power[1]]} peeked his own card at position ${power[2] + 1}`);
                }
                return;
            }
            if (power[0] === "PeekOtherCard") {
                if (power[3] in players) {
                    createNotification(`Player ${players[power[1]]} peeked card ${power[4] + 1} of player ${players[power[3]]}`);
                } else {
                    createNotification(`Player ${players[power[1]]} peeked your card ${power[4] + 1}`);
                }
                return;
            }
            if (power[0] === "BlindSwap") {
                if (power[3] in players) {
                    createNotification(`Player ${players[power[1]]} blind swapped card ${power[2] + 1} with card ${power[4] + 1} of player ${players[power[3]]}`);
                } else {
                    createNotification(`Player ${players[power[1]]} blind swapped card ${power[2] + 1} with your card ${power[4] + 1}`);
                }
                return;
            }

            if (power[0] === "CheckAndSwapStage1") {
                if (power[3] in players) {
                    createNotification(`Player ${players[power[1]]} peeked card ${power[4] + 1} of player ${players[power[3]]} and is deciding whether to swap`);
                } else {
                    createNotification(`Player ${players[power[1]]} peeked your card ${power[2] + 1} and is deciding whether to swap`);
                }
                return;
            }

            if ("CheckAndSwapStage2" in power[0]) {
                if (power[2] != null) {
                    if (power[3] in players) {
                        createNotification(`Player ${players[power[1]]} swapped card ${power[2] + 1} with card ${power[4] + 1} of player ${players[power[3]]}`);
                    } else {
                        createNotification(`Player ${players[power[1]]} swapped card ${power[2] + 1} with your card ${power[4] + 1}`);
                    }
                } else {
                    createNotification(`Player ${players[power[1]]} decided not to swap`);
                }
                return;
            }
        }

        function addPlayer(playerId, playerName) {
            players[playerId] = playerName;

            const newPlayerDivWaitingRoom = `
                    <div id="player-${playerId}-card" class="card mb-3" style="width: 100%;">
                        <div class="card-body">
                        <h5 class="card-title">${playerName}</h5>
                        </div>
                    </div>
            `
            playersContainer.insertAdjacentHTML("beforeend", newPlayerDivWaitingRoom);

            updateStartButtonText();
        }

        function removePlayer(playerId) {
            delete players[playerId];

            const playerCard = document.getElementById(`player-${playerId}-card`);

            playerCard.remove();
            updateStartButtonText();
        }

        function updateStartButtonText() {

            if (Object.keys(players).length >= 1) {
                startGameButton.innerText = "Start Game"
            } else {
                startGameButton.innerText = "Waiting for more players..."
            }
        }

        function startGame(cards) {
            createNotification('Game has started');
            waitingRoom.remove();
            for (let key in players) {
                const newPlayerCards = `
                <div id="container-player-${key}" class="bg-secondary text-black p-3 rounded position-relative">
                    <img id="crabul-badge-${key}" src="crabul-badge.svg" alt="CRABUL!" class="crabul-badge d-none">
                    <div class="fw-bold">${players[key]}</div>
                    <div id="cards-container-player-${key}"class="d-flex gap-3 p-2 mt-2">
                        <img id="player-${key}-card-0" src="cards/retro.svg" alt="Card" class="img-fluid hover-zoom" style="width: 60px;" draggable="true">
                        <img id="player-${key}-card-1" src="cards/retro.svg" alt="Card" class="img-fluid hover-zoom" style="width: 60px;" draggable="true">
                        <img id="player-${key}-card-2" src="cards/retro.svg" alt="Card" class="img-fluid hover-zoom" style="width: 60px;" draggable="true">
                        <img id="player-${key}-card-3" src="cards/retro.svg" alt="Card" class="img-fluid hover-zoom" style="width: 60px;" draggable="true">
                    </div>
                </div>`;
                playerCardContainer.insertAdjacentHTML("beforeend", newPlayerCards);
            }

            for (let i in [...Array(4).keys()]) {
                const playerCard = `
                    <img id="main-card-${i}" src="cards/retro.svg" alt="Card" class="img-fluid hover-zoom" style="width: 70px;" draggable="true">    
                `;
                mainPlayerCardContainer.insertAdjacentHTML("beforeend", playerCard);
            }

            document.getElementById("main-card-0").src = getCardImage(cards[0]);
            document.getElementById("main-card-1").src = getCardImage(cards[1]);

            gameRoom.style.display = "block";
            initializeDragAndDrop();
        }

        function coverCards() {
            const cards = document.querySelectorAll('[id^="main-card-"]');
            // Change the src of each matched element (assuming they're images)
            cards.forEach(card => {
                card.src = "cards/retro.svg";
            });
        }

        function getCardImage(card) {
            if (card === "Joker") {
                return "cards/joker.svg";
            }
            if ("Clubs" in card) {
                return `cards/0_${card["Clubs"]}.svg`;
            }
            if ("Diamonds" in card) {
                return `cards/1_${card["Diamonds"]}.svg`;
            }
            if ("Hearts" in card) {
                return `cards/2_${card["Hearts"]}.svg`;
            }
            if ("Spade" in card) {
                return `cards/3_${card["Spade"]}.svg`;
            }
            alert(`Card not recognized: ${JSON.stringify(card)}`)
        }

        function highlightCurrentPlayer(id) {
            let playerDiv;
            console.log("Current player turn is " + id + " player id is: " + userPlayerId);
            mainPlayerCardContainer.classList.remove("highlight-shadow");
            const playerDivs = document.querySelectorAll('[id^="container-player-"]');

            playerDivs.forEach(pdiv => {
                pdiv.classList.remove("highlight-shadow");
            });

            if (id === userPlayerId) {
                playerDiv = mainPlayerCardContainer;
            } else {
                playerDiv = document.getElementById(`container-player-${id}`);

            }
            playerDiv.classList.add("highlight-shadow");
        }

        function createNotification(message, error = false) {
            const container = document.getElementById("notification-container");

            // Create a new notification div
            const notification = document.createElement("div");
            notification.className = "notification";
            notification.textContent = message;

            if (error) {
                notification.classList.add("bg-warning");
            }

            // Append the notification to the container
            container.appendChild(notification);

            // Automatically remove the notification after 30 seconds
            setTimeout(() => {
                notification.remove();
            }, 10000); // 30 seconds
        }

        function initializeDragAndDrop() {
            const draggableCards = document.querySelectorAll('#main-player-card-container img[draggable="true"]');
            const droppableCards = document.querySelectorAll('[id^="cards-container-player-"] img');
            const droppableDiscardPile = document.getElementById('discard-pile');

            draggableCards.forEach(card => {
                initializeDraggableCard(card);
            });

            droppableCards.forEach(card => {
                initializeDroppableCard(card);
            });

            droppableDiscardPile.addEventListener('dragover', (e) => {
                e.preventDefault(); // Allow drop
            });

            droppableDiscardPile.addEventListener('drop', (e) => {
                e.preventDefault();
                console.log("HERE");

                const draggedCardId = e.dataTransfer.getData('text/plain'); // Get dragged card ID

                if (draggedCardId.startsWith("player-")) {
                    const split = draggedCardId.split("-");
                    const other_player_id = split[1];
                    const other_card_idx = split[3];
                    socket.send(`/throw ${other_player_id} ${other_card_idx}`);
                } else {
                    const card_idx = draggedCardId.split("-")[2];
                    socket.send(`/throw ${userPlayerId} ${card_idx}`);
                }
            });
        }

        function initializeDraggableCard(card) {
            card.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', card.id); // Store dragged card's ID
            });
            card.addEventListener('click', (e) => {
                if (powerState == "PeekOwnCard") {
                    const card_idx = card.id.split("-")[2];
                    socket.send(`/pow1 ${card_idx}`);
                }
                if (powerState == "CheckAndSwapStage2") {
                    const card_idx = card.id.split("-")[2];
                    socket.send(`/pow4_2 ${card_idx}`);
                }
                if (powerState == "Swap") {
                    const card_idx = card.id.split("-")[2];
                    socket.send(`/swap ${card_idx}`);
                    powerContainer.innerText = "";
                }
                if (powerState == "ChoosingCardToGive") {
                    const card_idx = card.id.split("-")[2];
                    socket.send(`/throw_2 ${card_idx}`);
                }
            });
        }

        function initializeDroppableCard(card) {
            card.addEventListener('click', (e) => {
                if (powerState == "PeekOtherCard") {
                    const split = card.id.split("-");
                    const other_player_id = split[1];
                    const other_card_idx = split[3];
                    socket.send(`/pow2 ${other_player_id} ${other_card_idx}`);
                }
                if (powerState == "CheckAndSwapStage1") {
                    const split = card.id.split("-");
                    const other_player_id = split[1];
                    const other_card_idx = split[3];
                    socket.send(`/pow4_1 ${other_player_id} ${other_card_idx}`);
                }
            });
            card.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', card.id); // Store dragged card's ID
            });

            card.addEventListener('dragover', (e) => {
                e.preventDefault(); // Allow drop
            });

            card.addEventListener('drop', (e) => {
                e.preventDefault();

                const draggedCardId = e.dataTransfer.getData('text/plain'); // Get dragged card ID
                const dropTargetId = card.id; // Get target card ID

                if (draggedCardId.startsWith("player-")) {
                    return;
                }

                const card_idx = draggedCardId.split("-")[2];
                const split = dropTargetId.split("-");
                const other_player_id = split[1];
                const other_card_idx = split[3];

                if (powerState == "BlindSwap") { // blind_swap
                    socket.send(`/pow3 ${card_idx} ${other_player_id} ${other_card_idx}`);
                }
            });
        }

        function showGameResults(data) {
            const gameResultModal = document.getElementById("game-result-modal");
            const scoresContainer = document.getElementById("game-scores");

            // Clear previous content
            scoresContainer.innerHTML = "";

            // Parse the data
            const gameData = data.GameTerminated;
            const winner = gameData.winner == userPlayerId ? userPlayerName : players[gameData.winner];

            // Create a heading for the winner
            const winnerHeading = document.createElement("h2");
            winnerHeading.textContent = `Winner: Player ${winner}`;
            scoresContainer.appendChild(winnerHeading);

            // Create a table for scores
            const scoresTable = document.createElement("table");
            scoresTable.style.width = "100%";
            scoresTable.style.borderCollapse = "collapse";

            // Add table headers
            const headers = document.createElement("tr");
            headers.innerHTML = `
                <th style="border: 1px solid #ddd; padding: 8px;">Player</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Cards</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Total Score</th>
            `;
            scoresTable.appendChild(headers);

            const suitMap = { Clubs: 0, Diamonds: 1, Hearts: 2, Spade: 3 };

            // Add rows for each player
            gameData.scores.forEach(score => {
                const row = document.createElement("tr");

                // Player ID
                const playerIdCell = document.createElement("td");
                playerIdCell.style.border = "1px solid #ddd";
                playerIdCell.style.padding = "8px";
                playerIdCell.textContent = score.player_id == userPlayerId ? userPlayerName : players[score.player_id];
                row.appendChild(playerIdCell);

                // Cards
                const cardsCell = document.createElement("td");
                cardsCell.style.border = "1px solid #ddd";
                cardsCell.style.padding = "8px";
                score.cards.forEach(card => {
                    const suit = Object.keys(card)[0];
                    const value = card[suit];
                    const suitId = suitMap[suit];
                    const cardImg = document.createElement("img");
                    if (card == "Joker") {
                        cardImg.src = `cards/joker.svg`;
                    } else {
                        cardImg.src = `cards/${suitId}_${value}.svg`;
                    }
                    cardImg.alt = `${value} of ${suit}`;
                    cardImg.style.width = "60px"; // Adjust size as needed
                    cardImg.style.marginRight = "5px";

                    cardsCell.appendChild(cardImg);
                });
                row.appendChild(cardsCell);

                // Total Score
                const totalScoreCell = document.createElement("td");
                totalScoreCell.style.border = "1px solid #ddd";
                totalScoreCell.style.padding = "8px";
                totalScoreCell.textContent = score.total_score;
                row.appendChild(totalScoreCell);

                scoresTable.appendChild(row);
            });

            scoresContainer.appendChild(scoresTable);

            // Show the modal
            gameResultModal.style.display = "flex";
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
</body>

</html>